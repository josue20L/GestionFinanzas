<h2 class="mb-4">Gestión de Empresas</h2>

<div class="d-flex justify-content-end mb-4">
    <button class="btn btn-primary" onclick="openCompanyModal()">
        <i class="bi bi-plus-lg me-2"></i> Nueva Empresa
    </button>
</div>

<div class="row" id="companiesGrid">
    <!-- Las empresas se cargarán aquí dinámicamente -->
</div>

<div id="no-companies" class="text-center py-5">
    <h3 class="text-muted">No hay empresas registradas</h3>
    <p class="text-secondary">Comienza creando tu primera empresa</p>
    <button class="btn btn-primary mt-3" onclick="openCompanyModal()">
        <i class="bi bi-plus-lg me-2"></i> Nueva Empresa
    </button>
</div>

<!-- Incluir el modal -->
<%- include('./modal') %>

<!-- JavaScript para gestión de empresas -->
<script>
// Función para abrir el modal
function openCompanyModal() {
    // Cargar datos necesarios (grupos y monedas)
    cargarGruposEmpresariales();
    cargarMonedas();
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('nuevaEmpresaModal'));
    modal.show();
}

// Editar empresa: cargar datos en el modal y enviar PUT al guardar
async function editarEmpresa(idEmpresa) {
    try {
        const response = await fetch(`/api/empresas/${idEmpresa}`);
        if (!response.ok) {
            showToast('No se pudo cargar la empresa para edición', 'danger');
            return;
        }
        const empresa = await response.json();

        await cargarGruposEmpresariales();
        await cargarMonedas();

        const form = document.getElementById('nuevaEmpresaForm');
        form.dataset.modo = 'editar';
        form.dataset.idEmpresa = idEmpresa;

        form.querySelector('[name="nombre_empresa"]').value = empresa.NOMBRE_EMPRESA || '';
        form.querySelector('[name="nit_ruc"]').value = empresa.NIT_RUC || '';
        form.querySelector('[name="pais"]').value = empresa.PAIS || '';
        form.querySelector('[name="id_grupo"]').value = empresa.ID_GRUPO || '';
        form.querySelector('[name="id_moneda"]').value = empresa.ID_MONEDA || '';

        const modalTitle = document.querySelector('#nuevaEmpresaModal .modal-title');
        if (modalTitle) modalTitle.textContent = 'Editar Empresa';

        const modal = new bootstrap.Modal(document.getElementById('nuevaEmpresaModal'));
        modal.show();
    } catch (error) {
        console.error('Error al editar empresa:', error);
        showToast('Error al cargar datos de la empresa', 'danger');
    }
}

// Eliminar empresa
async function eliminarEmpresa(idEmpresa) {
    if (!confirm('¿Está seguro de eliminar esta empresa? Esta acción no se puede deshacer.')) {
        return;
    }

    try {
        const response = await fetch(`/api/empresas/${idEmpresa}`, {
            method: 'DELETE'
        });
        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.message || 'Error al eliminar la empresa');
        }

        showToast('Empresa eliminada exitosamente', 'success');
        await cargarEmpresas();
    } catch (error) {
        console.error('Error al eliminar empresa:', error);
        showToast(error.message || 'Error al eliminar la empresa', 'danger');
    }
}

// Editar empresa: cargar datos en el modal y enviar PUT al guardar
async function editarEmpresa(idEmpresa) {
    try {
        // Obtener datos de la empresa
        const response = await fetch(`/api/empresas/${idEmpresa}`);
        if (!response.ok) {
            showToast('No se pudo cargar la empresa para edición', 'danger');
            return;
        }
        const empresa = await response.json();

        // Cargar catálogos
        await cargarGruposEmpresariales();
        await cargarMonedas();

        // Llenar formulario del modal
        const form = document.getElementById('nuevaEmpresaForm');
        form.dataset.modo = 'editar';
        form.dataset.idEmpresa = idEmpresa;

        form.querySelector('[name="nombre_empresa"]').value = empresa.NOMBRE_EMPRESA || '';
        form.querySelector('[name="nit_ruc"]').value = empresa.NIT_RUC || '';
        form.querySelector('[name="pais"]').value = empresa.PAIS || '';
        form.querySelector('[name="id_grupo"]').value = empresa.ID_GRUPO || '';
        form.querySelector('[name="id_moneda"]').value = empresa.ID_MONEDA || '';

        // Cambiar título del modal
        const modalTitle = document.querySelector('#nuevaEmpresaModal .modal-title');
        if (modalTitle) modalTitle.textContent = 'Editar Empresa';

        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('nuevaEmpresaModal'));
        modal.show();
    } catch (error) {
        console.error('Error al editar empresa:', error);
        showToast('Error al cargar datos de la empresa', 'danger');
    }
}

// Eliminar empresa
async function eliminarEmpresa(idEmpresa) {
    if (!confirm('¿Está seguro de eliminar esta empresa? Esta acción no se puede deshacer.')) {
        return;
    }

    try {
        const response = await fetch(`/api/empresas/${idEmpresa}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.message || 'Error al eliminar la empresa');
        }

        showToast('Empresa eliminada exitosamente', 'success');
        await cargarEmpresas();
    } catch (error) {
        console.error('Error al eliminar empresa:', error);
        showToast(error.message || 'Error al eliminar la empresa', 'danger');
    }
}

// Cargar grupos empresariales
async function cargarGruposEmpresariales() {
    try {
        const response = await fetch('/api/grupos-empresariales');
        const grupos = await response.json();
        
        const select = document.getElementById('grupoEmpresarial');
        select.innerHTML = '<option value="">Seleccionar grupo...</option>';
        
        grupos.forEach(grupo => {
            const option = document.createElement('option');
            option.value = grupo.ID_GRUPO;
            option.textContent = grupo.NOMBRE_GRUPO;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error al cargar grupos:', error);
        showToast('Error al cargar grupos empresariales', 'danger');
    }
}

// Cargar monedas
async function cargarMonedas() {
    try {
        const response = await fetch('/api/monedas');
        const monedas = await response.json();
        
        const select = document.getElementById('moneda');
        select.innerHTML = '<option value="">Seleccionar moneda...</option>';
        
        monedas.forEach(moneda => {
            const option = document.createElement('option');
            option.value = moneda.ID_MONEDA;
            option.textContent = `${moneda.NOMBRE_MONEDA} (${moneda.SIMBOLO})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error al cargar monedas:', error);
        showToast('Error al cargar monedas', 'danger');
    }
}

// Cargar empresas al iniciar
async function cargarEmpresas() {
    try {
        const response = await fetch('/api/empresas');
        const empresas = await response.json();
        
        const grid = document.getElementById('companiesGrid');
        const noCompanies = document.getElementById('no-companies');
        
        if (empresas && empresas.length > 0) {
            grid.innerHTML = '';
            empresas.forEach(empresa => {
                // Crear el card HTML directamente sin include
                const card = `
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${empresa.NOMBRE_EMPRESA || 'Sin nombre'}</h5>
                                <p class="card-text">
                                    <small class="text-muted">NIT/RUC: ${empresa.NIT_RUC || 'N/A'}</small><br>
                                    <small class="text-muted">País: ${empresa.PAIS || 'N/A'}</small><br>
                                    <small class="text-muted">Moneda: ${empresa.NOMBRE_MONEDA || 'N/A'}</small>
                                </p>
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editarEmpresa(${empresa.ID_EMPRESA})">
                                        <i class="bi bi-pencil"></i> Editar
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarEmpresa(${empresa.ID_EMPRESA})">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.innerHTML += card;
            });
            noCompanies.style.display = 'none';
        } else {
            grid.innerHTML = '';
            noCompanies.style.display = 'block';
        }
    } catch (error) {
        console.error('Error al cargar empresas:', error);
        showToast('Error al cargar empresas', 'danger');
    }
}

// Función para mostrar notificaciones toast
function showToast(message, type = 'info') {
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// Cargar empresas cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    cargarEmpresas();

    const form = document.getElementById('nuevaEmpresaForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(form);
            const payload = {
                nombre_empresa: formData.get('nombre_empresa'),
                nit_ruc: formData.get('nit_ruc'),
                pais: formData.get('pais'),
                id_grupo: formData.get('id_grupo') || null,
                id_moneda: formData.get('id_moneda')
            };

            const modo = form.dataset.modo || 'crear';
            const idEmpresa = form.dataset.idEmpresa;

            const url = modo === 'editar' && idEmpresa
                ? `/api/empresas/${idEmpresa}`
                : '/api/empresas';
            const method = modo === 'editar' && idEmpresa ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Error al guardar empresa');
                }

                // Cerrar modal
                const modalEl = document.getElementById('nuevaEmpresaModal');
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                modal.hide();

                // Resetear formulario a modo crear
                form.reset();
                delete form.dataset.modo;
                delete form.dataset.idEmpresa;
                const modalTitle = document.querySelector('#nuevaEmpresaModal .modal-title');
                if (modalTitle) modalTitle.textContent = 'Nueva Empresa';

                showToast(modo === 'editar' ? 'Empresa actualizada exitosamente' : 'Empresa creada exitosamente', 'success');
                await cargarEmpresas();
            } catch (error) {
                console.error('Error al guardar empresa:', error);
                showToast(error.message || 'Error al guardar empresa', 'danger');
            }
        });
    }
});
</script>
